// gfx.c (улучшенная версия с полным шрифтом)
#include "gfx.h"
#include "video.h"
#include "string.h"

GFX_Context gfx_ctx;

// Complete 4x6 font for Windows 2.0 style
static const uint8_t simple_font[128][6] = {
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['!'] = {0x04, 0x04, 0x04, 0x04, 0x00, 0x04},
    ['"'] = {0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00},
    ['#'] = {0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x00},
    ['$'] = {0x04, 0x0E, 0x05, 0x06, 0x0D, 0x06},
    ['%'] = {0x03, 0x13, 0x08, 0x04, 0x13, 0x18},
    ['&'] = {0x06, 0x09, 0x05, 0x0A, 0x11, 0x0E},
    ['\''] = {0x04, 0x04, 0x00, 0x00, 0x00, 0x00},
    ['('] = {0x08, 0x04, 0x04, 0x04, 0x04, 0x08},
    [')'] = {0x02, 0x04, 0x04, 0x04, 0x04, 0x02},
    ['*'] = {0x00, 0x04, 0x0E, 0x04, 0x00, 0x00},
    ['+'] = {0x00, 0x04, 0x0E, 0x04, 0x00, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x04, 0x02},
    ['-'] = {0x00, 0x00, 0x0E, 0x00, 0x00, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x04, 0x04},
    ['/'] = {0x08, 0x08, 0x04, 0x04, 0x02, 0x02},
    ['0'] = {0x0E, 0x11, 0x13, 0x15, 0x19, 0x0E},
    ['1'] = {0x04, 0x06, 0x04, 0x04, 0x04, 0x0E},
    ['2'] = {0x0E, 0x11, 0x08, 0x04, 0x02, 0x1F},
    ['3'] = {0x1F, 0x08, 0x04, 0x08, 0x11, 0x0E},
    ['4'] = {0x08, 0x0C, 0x0A, 0x09, 0x1F, 0x08},
    ['5'] = {0x1F, 0x01, 0x0F, 0x10, 0x11, 0x0E},
    ['6'] = {0x0C, 0x02, 0x01, 0x0F, 0x11, 0x0E},
    ['7'] = {0x1F, 0x10, 0x08, 0x04, 0x04, 0x04},
    ['8'] = {0x0E, 0x11, 0x0E, 0x11, 0x11, 0x0E},
    ['9'] = {0x0E, 0x11, 0x1E, 0x10, 0x08, 0x06},
    [':'] = {0x00, 0x04, 0x00, 0x00, 0x04, 0x00},
    [';'] = {0x00, 0x04, 0x00, 0x00, 0x04, 0x02},
    ['<'] = {0x08, 0x04, 0x02, 0x04, 0x08, 0x00},
    ['='] = {0x00, 0x0E, 0x00, 0x0E, 0x00, 0x00},
    ['>'] = {0x02, 0x04, 0x08, 0x04, 0x02, 0x00},
    ['?'] = {0x0E, 0x11, 0x08, 0x04, 0x00, 0x04},
    ['@'] = {0x0E, 0x11, 0x15, 0x17, 0x01, 0x0E},
    ['A'] = {0x04, 0x0A, 0x11, 0x1F, 0x11, 0x11},
    ['B'] = {0x0F, 0x11, 0x0F, 0x11, 0x11, 0x0F},
    ['C'] = {0x0E, 0x11, 0x01, 0x01, 0x11, 0x0E},
    ['D'] = {0x07, 0x09, 0x11, 0x11, 0x09, 0x07},
    ['E'] = {0x1F, 0x01, 0x0F, 0x01, 0x01, 0x1F},
    ['F'] = {0x1F, 0x01, 0x0F, 0x01, 0x01, 0x01},
    ['G'] = {0x0E, 0x11, 0x01, 0x1D, 0x11, 0x1E},
    ['H'] = {0x11, 0x11, 0x1F, 0x11, 0x11, 0x11},
    ['I'] = {0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E},
    ['J'] = {0x1C, 0x08, 0x08, 0x08, 0x09, 0x06},
    ['K'] = {0x11, 0x09, 0x05, 0x03, 0x05, 0x09},
    ['L'] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x1F},
    ['M'] = {0x11, 0x1B, 0x15, 0x11, 0x11, 0x11},
    ['N'] = {0x11, 0x13, 0x15, 0x19, 0x11, 0x11},
    ['O'] = {0x0E, 0x11, 0x11, 0x11, 0x11, 0x0E},
    ['P'] = {0x0F, 0x11, 0x0F, 0x01, 0x01, 0x01},
    ['Q'] = {0x0E, 0x11, 0x11, 0x15, 0x09, 0x16},
    ['R'] = {0x0F, 0x11, 0x0F, 0x05, 0x09, 0x11},
    ['S'] = {0x1E, 0x01, 0x0E, 0x10, 0x10, 0x0F},
    ['T'] = {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04},
    ['U'] = {0x11, 0x11, 0x11, 0x11, 0x11, 0x0E},
    ['V'] = {0x11, 0x11, 0x11, 0x0A, 0x0A, 0x04},
    ['W'] = {0x11, 0x11, 0x11, 0x15, 0x15, 0x0A},
    ['X'] = {0x11, 0x0A, 0x04, 0x04, 0x0A, 0x11},
    ['Y'] = {0x11, 0x0A, 0x04, 0x04, 0x04, 0x04},
    ['Z'] = {0x1F, 0x10, 0x08, 0x04, 0x02, 0x1F},
    ['['] = {0x0E, 0x02, 0x02, 0x02, 0x02, 0x0E},
    ['\\'] = {0x01, 0x01, 0x02, 0x02, 0x04, 0x04},
    [']'] = {0x0E, 0x08, 0x08, 0x08, 0x08, 0x0E},
    ['^'] = {0x04, 0x0A, 0x00, 0x00, 0x00, 0x00},
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x1F},
    ['`'] = {0x02, 0x04, 0x00, 0x00, 0x00, 0x00},
    ['a'] = {0x00, 0x00, 0x0E, 0x10, 0x1E, 0x1E},
    ['b'] = {0x01, 0x01, 0x0F, 0x11, 0x11, 0x0F},
    ['c'] = {0x00, 0x00, 0x0E, 0x01, 0x01, 0x0E},
    ['d'] = {0x10, 0x10, 0x1E, 0x11, 0x11, 0x1E},
    ['e'] = {0x00, 0x00, 0x0E, 0x1F, 0x01, 0x0E},
    ['f'] = {0x0C, 0x02, 0x07, 0x02, 0x02, 0x02},
    ['g'] = {0x00, 0x1E, 0x11, 0x1E, 0x10, 0x0E},
    ['h'] = {0x01, 0x01, 0x0F, 0x11, 0x11, 0x11},
    ['i'] = {0x04, 0x00, 0x06, 0x04, 0x04, 0x0E},
    ['j'] = {0x08, 0x00, 0x0C, 0x08, 0x08, 0x06},
    ['k'] = {0x01, 0x01, 0x09, 0x05, 0x03, 0x05},
    ['l'] = {0x06, 0x04, 0x04, 0x04, 0x04, 0x0E},
    ['m'] = {0x00, 0x00, 0x0B, 0x15, 0x15, 0x15},
    ['n'] = {0x00, 0x00, 0x0F, 0x11, 0x11, 0x11},
    ['o'] = {0x00, 0x00, 0x0E, 0x11, 0x11, 0x0E},
    ['p'] = {0x00, 0x00, 0x0F, 0x11, 0x0F, 0x01},
    ['q'] = {0x00, 0x00, 0x1E, 0x11, 0x1E, 0x10},
    ['r'] = {0x00, 0x00, 0x0B, 0x04, 0x04, 0x04},
    ['s'] = {0x00, 0x00, 0x0E, 0x06, 0x18, 0x0F},
    ['t'] = {0x02, 0x02, 0x07, 0x02, 0x02, 0x0C},
    ['u'] = {0x00, 0x00, 0x11, 0x11, 0x11, 0x1E},
    ['v'] = {0x00, 0x00, 0x11, 0x11, 0x0A, 0x04},
    ['w'] = {0x00, 0x00, 0x11, 0x15, 0x15, 0x0A},
    ['x'] = {0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A},
    ['y'] = {0x00, 0x00, 0x11, 0x0A, 0x04, 0x02},
    ['z'] = {0x00, 0x00, 0x1F, 0x08, 0x04, 0x1F},
    ['{'] = {0x08, 0x04, 0x04, 0x02, 0x04, 0x08},
    ['|'] = {0x04, 0x04, 0x04, 0x04, 0x04, 0x04},
    ['}'] = {0x02, 0x04, 0x04, 0x08, 0x04, 0x02},
    ['~'] = {0x00, 0x00, 0x00, 0x06, 0x09, 0x06}
};

void gfx_init() {
    gfx_ctx.width = video_get_width();
    gfx_ctx.height = video_get_height();
    gfx_ctx.framebuffer = video_get_framebuffer();
}

void gfx_clear_screen(uint8_t color) {
    for (int i = 0; i < gfx_ctx.width * gfx_ctx.height; i++) {
        gfx_ctx.framebuffer[i] = color;
    }
}

void gfx_draw_pixel(int x, int y, uint8_t color) {
    if (x >= 0 && x < gfx_ctx.width && y >= 0 && y < gfx_ctx.height) {
        gfx_ctx.framebuffer[y * gfx_ctx.width + x] = color;
    }
}

void gfx_draw_rect(int x, int y, int width, int height, uint8_t color) {
    // Top and bottom
    for (int i = x; i < x + width; i++) {
        gfx_draw_pixel(i, y, color);
        gfx_draw_pixel(i, y + height - 1, color);
    }
    // Left and right
    for (int j = y; j < y + height; j++) {
        gfx_draw_pixel(x, j, color);
        gfx_draw_pixel(x + width - 1, j, color);
    }
}

void gfx_fill_rect(int x, int y, int width, int height, uint8_t color) {
    for (int i = x; i < x + width; i++) {
        for (int j = y; j < y + height; j++) {
            gfx_draw_pixel(i, j, color);
        }
    }
}

void gfx_draw_line(int x1, int y1, int x2, int y2, uint8_t color) {
    int dx = (x2 > x1) ? (x2 - x1) : (x1 - x2);
    int dy = (y2 > y1) ? (y2 - y1) : (y1 - y2);
    int sx = (x1 < x2) ? 1 : -1;
    int sy = (y1 < y2) ? 1 : -1;
    int err = dx - dy;

    while (1) {
        gfx_draw_pixel(x1, y1, color);
        if (x1 == x2 && y1 == y2) break;
        int e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x1 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y1 += sy;
        }
    }
}

void gfx_draw_char(int x, int y, char c, uint8_t color) {
    if (c < 0 || c >= 128) return;
    
    const uint8_t* font_data = simple_font[(int)c];
    for (int dy = 0; dy < 6; dy++) {
        for (int dx = 0; dx < 4; dx++) {
            if (font_data[dy] & (1 << (3 - dx))) {
                gfx_draw_pixel(x + dx, y + dy, color);
            }
        }
    }
}

void gfx_draw_string(int x, int y, const char* str, uint8_t color) {
    while (*str) {
        gfx_draw_char(x, y, *str, color);
        x += 5;
        if (x >= gfx_ctx.width - 5) {
            x = 0;
            y += 8;
        }
        str++;
    }
}

void gfx_update() {
    // Direct framebuffer access - no double buffering for simplicity
}